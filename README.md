# Backend Take Home Assignment (MHA)

Submission by: Chai Youxiang </br>
Date of submission: 13 September 2024

Link to cloud deployment: [Click here](https://mha-be-takehome-git-main-youxiang-gits-projects.vercel.app/)

## Context

API used for tracking meditation sessions. Can have multiple users so username is required for adding a "session" as well as a start and end time.

StatsService (Dependency Injection) - used to calculate duration in minutes and some other stats (covered below)

## Backend API Implementation using Node.JS and Express.JS

### Tasks

1. Create a backend API with 3 endpoints:

    - GET request - Get an object by ID from a list of JSON object.
    - POST request - Add a new object.
    - DELETE request - Delete an object (should pass in an ID or some identifier).

2. Log all requests to the backend.

3. Validate the add and delete object requests.

4. Create a couple of unit tests cases to test out the endpoints.

5. Implement dependency injection.

**Bonus:** Deploy the above app to the cloud.

## Overview

### Installed dependencies:

<ul>
    <li> Express.JS - For our backend server</li>
    <li> Nodemon - Live reload (installed as DevDependency) </li>
    <li> JOI - HTTP Request Validation for JSON request body </li>
    <li> Pino - Middleware for logging all requests to server </li>
    <li> Mocha - Test runner </li>
    <li> Supertest - Testing framework </li>
    <li> Chai - Standalone expect functions </li>
</ul>

### File structure:

```
mha-be-takehome/
├── .git/
├── vercel/
├── lib/
│   ├── schema.js           // Validation schema
│   ├── StatsService.js
│   └── utils.js            // Utility function to ingest data & generate UUID
├── node_modules/
├── test/
│   ├── app.test.data.js    // Dummy test data
│   └── app.test.js         // Test file
├── .gitignore
├── app.js                  // App's entry-point
├── data.json               // Data to be loaded on server startup
├── package-lock.json
├── package.json
├── README.md
└── vercel.json             // Vercel configuration file
```

### Data Schema:

| Field             | Constraints                                                                                          |
| ----------------- | ---------------------------------------------------------------------------------------------------- |
| uuid              | A unique ID generated by the server using `uuid` module                                              |
| user              | Alphanumeric username string, between 5 to 10 characters long (Required)                             |
| startDateTime     | Start date & time of the meditation session                                                          |
| endDateTime       | End date & time for of the meditation session (Must be later than startDateTime, earlier than "now") |
| durationInMinutes | Duration of each session (generated by StatsService - DI)                                            |

The above schema can be found inside `schema.js` where I have set up JOI to be used for request validation. </br>

## Implementation

When the server first starts up, use `utils.js/fetchDataOnStartup()` to populate the "database" with data.

### 1. Create a backend API using Express.js server with 3 endpoints:

#### 1.1. GET request to fetch an object by ID from JSON object.

The GET endpoint is can be used with or without providing an 'ID' as a query string in the HTTP request. If no ID is provided, then all entries are returned.

#### 1.2. Add new object / entry

To add a new entry, I have created a POST request that validates the request body before appending it to the "database" to ensure that the following are met: </br>

-   <u>user</u> (username) is provided and valid with the above constraints
-   <u>endDateTime</u> is earlier than "now" and is later than <u>startDateTime</u> and both are provided

#### 1.3. Delete an object / entry

To delete an entry, its 'ID' needs to be provided. Validation is done to ensure that the 'ID' is indeed provided and that it is a valid uuid.

### 2. Log all requests to the backend.

This was implemented by using the `pino-http` module as **middleware**. </br>

The following lines of code were added to ensure that all request traffic is logged and formatted for easier reading:

```javascript
const pinoHttp = require("pino-http");
const pino = require("pino");

const logger = pino({
	transport: {
		target: "pino-pretty",
	},
});
const pinoHttpLogger = pinoHttp({ logger });
```

### 3. Validate the add and delete object requests.

Please refer to sections [1.2](#12-add-new-object--entry) and [1.3](#13-delete-an-object--entry)

### 4. Create a couple of unit tests cases to test out the endpoints.

Tests can be found inside `test/app.test.js` </br>
Created the following tests:

#### GET

1. All entries are returned if no 'ID' is provided in query string
2. One entry with specific 'ID' is returned when 'ID' is provided in query string

#### POST

1. Able to add a well formed entry to the database
2. Will throw an error if the required username is not provided
3. Will throw an error if the end time is earlier than start time

#### DELETE

1. Able to delete an entry given a well formed request with 'ID' provided in query string
2. Will throw an error if no 'ID' has been provided
3. Will throw a 404 not found if 'ID' does not match any entry
4. Will throw an error if the 'ID' provided is not a valid UUID

### 5. Implement dependency injection

Implemented in the form of `StatsServices` injected via middleware to the Request

The StatsService will calculate some simple stats when passing a user's username to the GET endpoint as `/:id` e.g. `/cyx123`

The stats generated are (in minutes):

1. Duration of each session
2. Average time spent
3. Total time spent

### Deploy to cloud

The app has been deployed to Vercel and can be accessible via at this [link](https://mha-be-takehome-git-main-youxiang-gits-projects.vercel.app/).
